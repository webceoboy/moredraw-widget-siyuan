<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MoreDraw</title>

</head>
<body style="padding: 0;margin: 0;">

<script>
    const node = self.frameElement.parentElement.parentElement;
    const id = node.getAttribute('data-node-id');
    let path = node.getAttribute('data-path');
    path = path ? path : 'get-started/siyuan';

    window.addEventListener("message", (event) => {
        console.log(event);
        if (event.data && event.data.action == 'routeAfterEach') {
            fetch('/api/attr/setBlockAttrs', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "id": id,
                    "attrs": {
                        "data-path": event.data.data,
                    }
                })
            })
        }
    });

    window.onload = function () {
        const url = new URL(('https://moredraw.com/app/' + path).replaceAll('//', '/'));
        url.searchParams.set('utm_source', 'siyuan');
        const iframe = document.createElement('iframe');
        iframe.frameBorder = '0';
        iframe.style.width = '100vw';
        iframe.style.height = '100vh';
        iframe.src = url.toString();

        function hideToolBar() {
            iframe.contentWindow.postMessage({action: 'hideToolbar'}, '*')
        }

        node.addEventListener('mouseenter', () => {
            iframe.contentWindow.postMessage({action: 'showToolbar'}, '*')
        });
        node.addEventListener('mouseleave', () => {
            hideToolBar()
        });
        node.parentElement.addEventListener('click', (event) => {
            const clickedElement = event.target;
            if (!node.contains(clickedElement)) {
                // 如果点击的元素不在目标 div 内部
                console.debug('点击', clickedElement)
                hideToolBar()
            } else {
                console.log('点击了目标 div');
            }
        });
        node.parentElement.addEventListener('touchstart', (event) => {
            const clickedElement = event.target;
            if (!node.contains(clickedElement)) {
                // 如果点击的元素不在目标 div 内部
                console.debug('点击', clickedElement)
                hideToolBar()
            } else {
                console.log('点击了目标 div');
            }
        });
        document.body.appendChild(iframe);
    }
</script>
</body>
</html>